name: Backend Rollback

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'ë¡¤ë°±í•  í™˜ê²½'
        required: true
        type: choice
        options:
          - develop
          - main
      run_number:
        description: 'ë¡¤ë°±í•  Run Number'
        required: true
        type: string

jobs:
  rollback:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment == 'main' && 'production' || 'development' }}
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 1. GitHub CLIë¥¼ ì´ìš©í•´ run_numberì— í•´ë‹¹í•˜ëŠ” ì‹¤ì œ run-idë¥¼ ì°¾ìŠµë‹ˆë‹¤.
      - name: Find Run ID
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # ì§€ì •í•œ ë¸Œëœì¹˜ì™€ run_numberì— ë§ëŠ” run-id ì°¾ê¸°
          RUN_ID=$(gh run list \
            --workflow "Backend CI/CD - Full Pipeline" \
            --json databaseId,number,headBranch \
            --jq ".[] | select(.number == ${{ inputs.run_number }} and .headBranch == \"${{ inputs.environment }}\") | .databaseId" \
            | head -n 1)

          if [ -z "$RUN_ID" ]; then
            echo "âŒ Error: ${{ inputs.environment }} ë¸Œëœì¹˜ì˜ Run Number ${{ inputs.run_number }}ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
            echo ""
            echo "ì‚¬ìš© ê°€ëŠ¥í•œ ìµœê·¼ ë¹Œë“œ ëª©ë¡:"
            gh run list --workflow "Backend CI/CD - Full Pipeline" --branch "${{ inputs.environment }}" --limit 10
            exit 1
          fi

          echo "FOUND_RUN_ID=$RUN_ID" >> $GITHUB_ENV
          echo "âœ… ì°¾ì€ Run ID: $RUN_ID (Run Number: ${{ inputs.run_number }}, Branch: ${{ inputs.environment }})"

      # 2. ì°¾ì€ Run IDë¥¼ ì‚¬ìš©í•˜ì—¬ ì•„í‹°íŒ©íŠ¸ë¥¼ ë‹¤ìš´ë¡œë“œí•©ë‹ˆë‹¤.
      - name: Download Artifact
        uses: actions/download-artifact@v4
        with:
          name: backend-jar-${{ inputs.environment }}-${{ inputs.run_number }}
          run-id: ${{ env.FOUND_RUN_ID }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          path: ./rollback-temp

      # 3. ë‹¤ìš´ë¡œë“œí•œ JAR íŒŒì¼ í™•ì¸
      - name: Show JAR Info
        run: |
          echo "=== Rollback JAR Info ==="
          ls -lh ./rollback-temp/
          echo ""
          JAR_FILE=$(ls ./rollback-temp/*.jar | head -1)
          if [ -f "$JAR_FILE" ]; then
            echo "ë¡¤ë°±í•  JAR íŒŒì¼: $(basename $JAR_FILE)"
          else
            echo "âŒ JAR íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
            exit 1
          fi

      # 4. ì„œë²„ë¡œ JAR íŒŒì¼ ì „ì†¡
      - name: Transfer to Server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.KEY }}
          port: ${{ secrets.PORT }}
          source: "./rollback-temp/*.jar"
          target: "/home/${{ secrets.USERNAME }}/backend/rollback"
          strip_components: 1

      # 5. ë¡¤ë°± ì‹¤í–‰
      - name: Deploy Rollback
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.KEY }}
          port: ${{ secrets.PORT }}
          script: |
            ROLLBACK_DIR="/home/${{ secrets.USERNAME }}/backend/rollback"
            DEPLOY_DIR="/home/${{ secrets.USERNAME }}/backend"
            BACKUP_DIR="/home/${{ secrets.USERNAME }}/backend/backup-$(date +%Y%m%d-%H%M%S)"

            # ë¡¤ë°±í•  JAR íŒŒì¼ ì°¾ê¸°
            ROLLBACK_JAR=$(ls -t $ROLLBACK_DIR/*.jar | head -1)
            if [ -z "$ROLLBACK_JAR" ]; then
              echo "âŒ ë¡¤ë°±í•  JAR íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
              exit 1
            fi

            echo "ğŸ”„ ë¡¤ë°± ì‹œì‘..."
            echo "ë¡¤ë°±í•  JAR: $(basename $ROLLBACK_JAR)"

            # í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ ì„œë¹„ìŠ¤ í™•ì¸
            CURRENT_PORT=$(cat $DEPLOY_DIR/current_port.txt 2>/dev/null || echo "8080")
            if [ "$CURRENT_PORT" = "8080" ]; then
              TARGET_PORT=8081
            else
              TARGET_PORT=8080
            fi

            echo "í˜„ì¬ í™œì„± í¬íŠ¸: $CURRENT_PORT"
            echo "ë¡¤ë°± íƒ€ê²Ÿ í¬íŠ¸: $TARGET_PORT"

            # í˜„ì¬ ë°°í¬ëœ JAR ë°±ì—…
            mkdir -p $BACKUP_DIR
            if [ -f "$DEPLOY_DIR/application.jar" ]; then
              cp $DEPLOY_DIR/application.jar $BACKUP_DIR/
              echo "âœ… í˜„ì¬ JAR ë°±ì—… ì™„ë£Œ: $BACKUP_DIR"
            fi

            # íƒ€ê²Ÿ í¬íŠ¸ì—ì„œ ì‹¤í–‰ ì¤‘ì¸ ì• í”Œë¦¬ì¼€ì´ì…˜ ì¢…ë£Œ
            TARGET_PID=$(lsof -ti:$TARGET_PORT)
            if [ ! -z "$TARGET_PID" ]; then
              echo "íƒ€ê²Ÿ í¬íŠ¸($TARGET_PORT)ì—ì„œ ì‹¤í–‰ ì¤‘ì¸ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ: $TARGET_PID"
              kill -15 $TARGET_PID
              sleep 5
            fi

            # ë¡¤ë°± JARë¥¼ íƒ€ê²Ÿ í¬íŠ¸ì— ë°°í¬
            cp $ROLLBACK_JAR $DEPLOY_DIR/application-rollback.jar
            nohup java -jar $DEPLOY_DIR/application-rollback.jar --server.port=$TARGET_PORT > $DEPLOY_DIR/rollback-$TARGET_PORT.log 2>&1 &

            # í—¬ìŠ¤ì²´í¬ (ìµœëŒ€ 60ì´ˆ)
            echo "í—¬ìŠ¤ì²´í¬ ì‹œì‘..."
            for i in {1..12}; do
              sleep 5
              HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:$TARGET_PORT/actuator/health || echo "000")
              if [ "$HTTP_STATUS" = "200" ]; then
                echo "âœ… ë¡¤ë°±ëœ ì• í”Œë¦¬ì¼€ì´ì…˜ ì •ìƒ êµ¬ë™ í™•ì¸ (í¬íŠ¸: $TARGET_PORT)"

                # Nginx í¬íŠ¸ ì „í™˜
                echo "Nginx í¬íŠ¸ ì „í™˜ ì¤‘..."
                echo "set \$service_port $TARGET_PORT;" > $DEPLOY_DIR/service_port.conf
                sudo nginx -s reload

                # ì´ì „ í¬íŠ¸ ì• í”Œë¦¬ì¼€ì´ì…˜ ì¢…ë£Œ
                OLD_PID=$(lsof -ti:$CURRENT_PORT)
                if [ ! -z "$OLD_PID" ]; then
                  echo "ì´ì „ í¬íŠ¸($CURRENT_PORT) ì• í”Œë¦¬ì¼€ì´ì…˜ ì¢…ë£Œ: $OLD_PID"
                  kill -15 $OLD_PID
                fi

                # í˜„ì¬ í¬íŠ¸ ì—…ë°ì´íŠ¸
                echo $TARGET_PORT > $DEPLOY_DIR/current_port.txt

                # ì •ë¦¬
                rm -rf $ROLLBACK_DIR/*

                echo "âœ… ë¡¤ë°± ì™„ë£Œ!"
                echo "í™œì„± í¬íŠ¸: $TARGET_PORT"
                exit 0
              fi
              echo "ëŒ€ê¸° ì¤‘... ($i/12)"
            done

            echo "âŒ ë¡¤ë°± ì‹¤íŒ¨: í—¬ìŠ¤ì²´í¬ íƒ€ì„ì•„ì›ƒ"
            ROLLBACK_PID=$(lsof -ti:$TARGET_PORT)
            if [ ! -z "$ROLLBACK_PID" ]; then
              kill -15 $ROLLBACK_PID
            fi
            exit 1

      # 6. ë¡¤ë°± ê²°ê³¼ ì•Œë¦¼
      - name: Notify Rollback Result
        if: always()
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK_URL }}
          title: "ë°±ì—”ë“œ ${{ inputs.environment == 'main' && 'ìš´ì˜' || 'ê°œë°œ' }} ì„œë²„ ë¡¤ë°± ${{ job.status == 'success' && 'ì„±ê³µ âœ…' || 'ì‹¤íŒ¨ âŒ' }}"
          description: |
            **ê²°ê³¼:** ${{ job.status }}
            **í™˜ê²½:** ${{ inputs.environment == 'main' && 'ìš´ì˜' || 'ê°œë°œ' }}
            **ë¡¤ë°± ëŒ€ìƒ Run Number:** ${{ inputs.run_number }}
            **ì‹¤í–‰ì:** ${{ github.actor }}
          color: ${{ job.status == 'success' && '0x00ff00' || '0xff0000' }}
