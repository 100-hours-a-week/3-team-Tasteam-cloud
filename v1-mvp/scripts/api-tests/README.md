# API Tests

k6 ê¸°ë°˜ API í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸ ëª¨ìŒì…ë‹ˆë‹¤.

## ğŸ“ êµ¬ì¡°

```
api-tests/
â”œâ”€â”€ smoke_test.js        # ìŠ¤ëª¨í¬ í…ŒìŠ¤íŠ¸ (ì—°ê²°ì„± ê²€ì¦)
â”œâ”€â”€ breakpoint_test.js   # ë¸Œë ˆì´í¬í¬ì¸íŠ¸ í…ŒìŠ¤íŠ¸ (í•œê³„ì  íƒìƒ‰)
â”œâ”€â”€ search_stress_test.js # ê²€ìƒ‰ ê¸°ëŠ¥ ì§‘ì¤‘ ë¶€í•˜ í…ŒìŠ¤íŠ¸
â”œâ”€â”€ run-breakpoint.sh    # ë¸Œë ˆì´í¬í¬ì¸íŠ¸ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ìŠ¤í¬ë¦½íŠ¸
â”œâ”€â”€ run-search-stress.sh # ê²€ìƒ‰ ë¶€í•˜ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ìŠ¤í¬ë¦½íŠ¸
â””â”€â”€ shared/
    â”œâ”€â”€ scenarios.js     # ê³µí†µ ì‹œë‚˜ë¦¬ì˜¤ ë° í—¬í¼ í•¨ìˆ˜
    â””â”€â”€ test-utils.js    # ë¡œê·¸ ë° ë©”íŠ¸ë¦­ ìœ í‹¸ë¦¬í‹°
```

## ğŸ”§ í™˜ê²½ ë³€ìˆ˜

ëª¨ë“  í™˜ê²½ë³€ìˆ˜ëŠ” ê¸°ë³¸ê°’ì´ ì„¤ì •ë˜ì–´ ìˆì–´ ë³„ë„ ì„¤ì • ì—†ì´ ë°”ë¡œ ì‹¤í–‰ ê°€ëŠ¥í•©ë‹ˆë‹¤.
í•„ìš”ì‹œì—ë§Œ overrideí•˜ì„¸ìš”.

| ë³€ìˆ˜ | ì„¤ëª… | ê¸°ë³¸ê°’ |
|-----|------|-------|
| `BASE_URL` | í…ŒìŠ¤íŠ¸ ëŒ€ìƒ ì„œë²„ URL | `https://dev.tasteam.kr` |
| `K6_PROMETHEUS_RW_SERVER_URL` | Prometheus Remote Write URL | `https://prom.tasteam.kr/api/v1/write` |
| `K6_PROMETHEUS_RW_USERNAME` | Prometheus Basic Auth ê³„ì •ëª… | `tasteam` |
| `K6_PROMETHEUS_RW_PASSWORD` | Prometheus Basic Auth ë¹„ë°€ë²ˆí˜¸ | (ë‚´ì¥) |

> ğŸ”’ **ë³´ì•ˆ ì£¼ì˜**: ì‹¤ì œ ê³„ì •ëª…ê³¼ ë¹„ë°€ë²ˆí˜¸ëŠ” ë³´ì•ˆìƒ `.envrc` íŒŒì¼ ë“±ì„ í†µí•´ í™˜ê²½ë³€ìˆ˜ë¡œ ì§ì ‘ ì„ ì–¸í•´ì•¼ ì•ˆì „í•˜ê²Œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.
> `.envrc` íŒŒì¼ì€ `.gitignore`ì— í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.

## ğŸ§ª í…ŒìŠ¤íŠ¸ ì¢…ë¥˜

### ìŠ¤ëª¨í¬ í…ŒìŠ¤íŠ¸ (`smoke_test.js`)

ë°°í¬ í›„ ê¸°ë³¸ ì—°ê²°ì„±ê³¼ API ë™ì‘ì„ ë¹ ë¥´ê²Œ ê²€ì¦í•©ë‹ˆë‹¤.

- **VU**: 1ëª…
- **Duration**: 10ì´ˆ
- **ìš©ë„**: CI/CD íŒŒì´í”„ë¼ì¸, ë°°í¬ ì§í›„ ìƒíƒœ í™•ì¸

```bash
k6 run smoke_test.js
```

### ë¸Œë ˆì´í¬í¬ì¸íŠ¸ í…ŒìŠ¤íŠ¸ (`breakpoint_test.js`)

ì‹œìŠ¤í…œì´ SLOë¥¼ ìœ„ë°˜í•˜ê¸° ì‹œì‘í•˜ëŠ” ë¶€í•˜ ìˆ˜ì¤€ì„ íƒìƒ‰í•©ë‹ˆë‹¤.

- **ì‹œë‚˜ë¦¬ì˜¤**: ì¡°íšŒ(80%) + ì“°ê¸°(20%) ë™ì‹œ ì‹¤í–‰
- **ë¶€í•˜**: ì ì§„ì  ì¦ê°€ (ìµœëŒ€ ì¡°íšŒ 240 RPS, ì“°ê¸° 60 RPS)
- **Duration**: 8ë¶„

**SLO ê¸°ì¤€:**

| ì‹œë‚˜ë¦¬ì˜¤ | ì„ê³„ì¹˜ |
|---------|--------|
| ì¡°íšŒ API | p95 < 1ì´ˆ |
| ë¦¬ë·° ì‘ì„± | p95 < 3ì´ˆ |
| ì—ëŸ¬ìœ¨ | < 0.1% |

```bash
# ê¸°ë³¸ ì‹¤í–‰ (Prometheus ì¶œë ¥ ìë™ í™œì„±í™”)
./run-breakpoint.sh

# DB ì´ˆê¸°í™” í›„ ì‹¤í–‰
./run-breakpoint.sh --reset-db

# Prometheus ì¶œë ¥ ë¹„í™œì„±í™”
./run-breakpoint.sh --no-prometheus
```

### ê²€ìƒ‰ ë¶€í•˜ í…ŒìŠ¤íŠ¸ (`search_stress_test.js`)

ê²€ìƒ‰ ê¸°ëŠ¥ì— ëŒ€í•œ ì§‘ì¤‘ì ì¸ ë¶€í•˜ë¥¼ ë°œìƒì‹œí‚µë‹ˆë‹¤.

- **ì‹œë‚˜ë¦¬ì˜¤**: í‚¤ì›Œë“œ ê²€ìƒ‰ (100%)
- **ë¶€í•˜**: ìµœëŒ€ 6000 VUsê¹Œì§€ ë‹¨ê³„ì  ì¦ê°€
- **Duration**: ì•½ 6ë¶„

```bash
# ì‹¤í–‰
./run-search-stress.sh
```

## ğŸ“Š Prometheus / Grafana ì—°ë™

`run-breakpoint.sh` ì‹¤í–‰ ì‹œ **ê¸°ë³¸ì ìœ¼ë¡œ Prometheus ì¶œë ¥ì´ í™œì„±í™”**ë©ë‹ˆë‹¤.
ë„¤ì´í‹°ë¸Œ íˆìŠ¤í† ê·¸ë¨ë„ ìŠ¤í¬ë¦½íŠ¸ ë‚´ì—ì„œ ìë™ í™œì„±í™”ë©ë‹ˆë‹¤.

```bash
# ê·¸ëƒ¥ ì‹¤í–‰í•˜ë©´ ë¨ (ëª¨ë“  ì„¤ì • ë‚´ì¥)
./run-breakpoint.sh

# ë‹¤ë¥¸ Prometheus ì„œë²„ë¡œ ì „ì†¡í•˜ê³  ì‹¶ë‹¤ë©´:
K6_PROMETHEUS_RW_SERVER_URL="http://other-prom:9090/api/v1/write" ./run-breakpoint.sh
```

**ë„¤ì´í‹°ë¸Œ íˆìŠ¤í† ê·¸ë¨ ì¥ì :**
- ì €ì¥ ê³µê°„ ìµœëŒ€ 10ë°° ì ˆì•½
- ë” ì •í™•í•œ ë°±ë¶„ìœ„ìˆ˜ ê³„ì‚°
- ë²„í‚· ë¯¸ë¦¬ ì •ì˜ ë¶ˆí•„ìš”

> Prometheus v3.8.0+ ë° Grafana 9.4+ì—ì„œ ì •ì‹ ì§€ì› (Stable)

### Test ID ë° ë©”íŠ¸ë¦­

ëª¨ë“  í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì‹œ ê³ ìœ í•œ `Test ID`ê°€ ë¶€ì—¬ë©ë‹ˆë‹¤.

- **Tag**: `testid`
- **ë¡œê·¸**: ì‹¤í–‰ ì‹œì‘ ì‹œ ì½˜ì†”ì— ì¶œë ¥ (ì˜ˆ: `breakpoint-20250204-123456`)

**ì£¼ìš” ì»¤ìŠ¤í…€ ë©”íŠ¸ë¦­:**

- `request_success_count`: ì „ì²´ HTTP ìš”ì²­ ì„±ê³µ ìˆ˜ (ëˆ„ì )
- `read_success_count`: ì¡°íšŒ ì‹œë‚˜ë¦¬ì˜¤ ì„±ê³µ ìˆ˜
- `write_success_count`: ì“°ê¸° ì‹œë‚˜ë¦¬ì˜¤ ì„±ê³µ ìˆ˜
- `search_success_count`: ê²€ìƒ‰ ì‹œë‚˜ë¦¬ì˜¤ ì„±ê³µ ìˆ˜

## ğŸ§© ê³µí†µ ëª¨ë“ˆ (`shared/scenarios.js`)

í…ŒìŠ¤íŠ¸ ê°„ ì¬ì‚¬ìš©ë˜ëŠ” í•¨ìˆ˜ë“¤ì„ ì œê³µí•©ë‹ˆë‹¤.

### ì¸ì¦

- `login()` - í…ŒìŠ¤íŠ¸ ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸, í† í° ë°˜í™˜
- `joinGroup(token)` - ê·¸ë£¹ ê°€ì…
- `getReviewKeywords(token)` - ë¦¬ë·° í‚¤ì›Œë“œ ëª©ë¡ ì¡°íšŒ

### ì¡°íšŒ API

- `getMainPage(token)` - ë©”ì¸ í˜ì´ì§€
- `getRestaurantList(token)` - ìŒì‹ì  ëª©ë¡
- `getRestaurantDetail(token, id)` - ìŒì‹ì  ìƒì„¸
- `getRestaurantReviews(token, id)` - ìŒì‹ì  ë¦¬ë·° ëª©ë¡
- `getGroupDetail(token, id)` - ê·¸ë£¹ ìƒì„¸
- `getGroupReviews(token, id)` - ê·¸ë£¹ ë¦¬ë·° ëª©ë¡
- `getReviewDetail(token, id)` - ë¦¬ë·° ìƒì„¸
- `search(token, keyword)` - í†µí•© ê²€ìƒ‰

### ì“°ê¸° API

- `createReview(token, groupId, keywordIds)` - ë¦¬ë·° ì‘ì„±

### ë³µí•© ì‹œë‚˜ë¦¬ì˜¤

- `executeReadScenario(state)` - ì „ì²´ ì¡°íšŒ ì‹œë‚˜ë¦¬ì˜¤ (SLO: p95 < 1ì´ˆ)
- `executeWriteScenario(state)` - ì „ì²´ ì“°ê¸° ì‹œë‚˜ë¦¬ì˜¤ (SLO: p95 < 3ì´ˆ)

## ğŸ“‹ í…ŒìŠ¤íŠ¸ ê³„ì • ì •ë³´

í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸ëŠ” ì•„ë˜ ê³ ì • í…ŒìŠ¤íŠ¸ ë°ì´í„°ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤:

| í•­ëª© | ê°’ |
|-----|-----|
| ì‚¬ìš©ì ì‹ë³„ì | `test-user-001` |
| ë‹‰ë„¤ì„ | `ìŠ¤ëª¨í¬í…ŒìŠ¤íŠ¸ê³„ì •1` |
| í…ŒìŠ¤íŠ¸ ê·¸ë£¹ ID | `2002` |
| ê·¸ë£¹ ì½”ë“œ | `LOCAL-1234` |
| í…ŒìŠ¤íŠ¸ ìŒì‹ì  ID | `6001` |

> âš ï¸ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì „ ì‹œë“œ ë°ì´í„°ê°€ ì ì¬ë˜ì–´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.

## ğŸ”„ DB ì´ˆê¸°í™”

í…ŒìŠ¤íŠ¸ ë°ì´í„° ì˜¤ì—¼ì„ ë°©ì§€í•˜ë ¤ë©´ DB ì´ˆê¸°í™” í›„ ì‹¤í–‰í•˜ì„¸ìš”:

```bash
# DB ì´ˆê¸°í™” í›„ ë¸Œë ˆì´í¬í¬ì¸íŠ¸ í…ŒìŠ¤íŠ¸
./run-breakpoint.sh --reset-db

# ìˆ˜ë™ ì´ˆê¸°í™”
../db-reset/reset-dev-db.sh
```
